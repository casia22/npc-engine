# 🌟 需求文档 🌟

![Demo GIF](https://jackal-u-dance.oss-cn-beijing.aliyuncs.com/demo.gif)


## 👋 greetings！！！～～～

你好，我们是cogniMatrix (认知矩阵) 团队，

这是我们目前正在开发的 npc-engine 的工作，项目的目的是最终能用于社会模拟、单机游戏，甚至是数字员工。

希望您能在创造自己的小小伊甸园时感到快乐。

❗️ 使用的时候发现问题 issue 请反馈至 QQ 群："823027863" 或提issue.

## 目前核心开发需求
调用 npc-engine 做一个 Unity2D 小游戏场景，通过发送 UDP 包的形式让 NPC 动起来，形成一个有张力的多人小镇。

参考项目代码⚠️：[ai_rpg 项目](https://github.com/casia22/ai_rpg/tree/MattCao)

## 场景设置 (例)
小镇 🏘️ 矿场 ⛏️ 森林 🌳

小镇的村民多数居住在小镇中，矿场中有一些矿工，森林中有一些猎人。

小镇中人物：
- 村长 👴 1
- 警长 👮‍♂️、辅警 👮‍♂️ 1 2
- 村民 🧑‍🌾 10
- 老村民 🧓 5
- 小孩 👶 5

矿场中人物：
- 矿工 ⛏️ 5
- 矿场老板 💼 1

森林中人物：
- 猎人 🏹 5
- 动物保护主义者 🌿 3

整体的游戏情节没有显式的定义方式，人物之间的互动依赖于 npc-engine\src\config\npc 中每个 npc 的自我背景描述。

你可以发挥自己的创造力来构建具有戏剧冲突的角色，后面的情节目前是不可控的。

目前 NPC 的记忆会同时保存在本地数据库和线上数据库中，不支持删除 NPC 记忆。

每次切换场景要发送一个 init 包，把对应的 NPC 加载到内存里。

## 动作设置
动作可以参照 npc-engine\src\config\action 中的配置文件按照你的喜好添加

## NPC 的观察 👀 设置
npc-engine 并不包括 NPC 的眼睛 👀，其对四周的观察依赖于你的自然语言描述，通过字符串列表的方式表示。

比如 NPC 的视野中有 椅子x4 老人x2 小孩x1，那么你可以这样描述：
```
[椅子#1, 椅子#2, 椅子#3, 椅子#4<老人:张大爷#1占用>, 老人:李大爷#2, 小孩:小米#1]
```

这个观察函数需要你来实现，当然，你也可以尝试其他的 NPC 感知表述方式，说不定会有惊喜。

## unity 端逻辑
### 处理接受包逻辑
目前有两类接收包，一种是 conversation 包，一种是 action 包。

conversation 包包含一次对话房间 (session) 中玩家所有对话 (我们称之为剧本)，剧本的条目需要你按照合理的方式来处理并分发给指定的 NPC 让其念出 (气泡)。
action 包则是针对单个 npc 的动作和动作参数，你需要将其分发给指定的 NPC 让其执行动作。

由于包处理分发模块就像上帝一样摆弄游戏环境中的一切，在我们的内部开发中，我们称 Unity 端的包分发模块为 "上帝之手"。

目前在[ai_rpg 项目](https://github.com/casia22/ai_rpg/tree/MattCao)中，上帝之手仅仅实现了对话的分发逻辑，没有处理 action 的逻辑。

### 发送包逻辑
##### 发送包基本上只有下面几种情况：

引擎初始化 (场景初始化):

需要发送 init 包，指定场景 json (在 game_world.json 中) 和 scene.json 中

conversation 相关：

当 NPC 之间的距离 (或者其他你定义的逻辑) 满足指定条件的时候，需要发送 conversation 包。
当收到一整个剧本的时候，你分发给指定的 NPC 让其念台词，念完后需要发送台词确认包到 ENGINE，这样 ENGINE 才会记住这次对话。

action 相关:

当一个 action 被发送给 NPC 执行的时候，执行完毕有两种情况：成功和失败。
无论如何，都要发送 action done 包到 engine。
如果失败了，要自动生成失败的原因 REASON，需要是第三人称自然语言的形式。

## engine 端逻辑

请参考engine的readme
